from ipaddress import ip_address

def insert_rule(bfrt):
    #L2
    p4 = bfrt.hypervisor_tf4.SwitchIngress
    p4.table_header_match_stage1.add_with_set_action_id1(1,0x0000000000050000000000000000,0xFFFFFFFFFFFF0000000000000000, 0x0000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000, 0x0000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000, 0x00000001, 0x00000001)
    p4.table_set_next_stage1.add_with_set_next_stage(1,1)
    p4.table_action_forward_stage1.add_with_action_forward(1,0x0000,1,1,168)
    p4.table_action_mod_112_srcAddr_stage1.add_with_action_mod_112_srcAddr(1, 0x0000000000000000000001050000)

    #L3
    p4.table_header_match_stage1.add_with_set_action_id1(2,0x0000000000000000000000000000,0x0000000000000000000000000000, 0x000000000000000000000000000000000A0A0006,0x00000000000000000000000000000000FFFFFFFF, 0x0000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000, 1,0x00000001)
    p4.table_set_next_stage1.add_with_set_next_stage(2,1)
    p4.table_action_forward_stage1.add_with_action_forward(2,0x0000,1,1,169)
    p4.table_action_mod_112_srcAddr_stage1.add_with_action_mod_112_srcAddr(2, 0x0000000000000000000001060000)
    
    #FW
        # any packet => pass
    p4.table_header_match_stage1.add_with_set_action_id1(3,0x0000000000000000000000000000,0x0000000000000000000000000000, 0x0000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000, 0x0000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000, 1,0x00000001)
    p4.table_action_forward_stage1.add_with_action_forward(3,0x0000,1,1, 170)
    p4.table_set_next_stage1.add_with_set_next_stage(3,2)

        # port 22 => drop
    p4.table_header_match_stage2.add_with_set_action_id2(3,0x0000000000000000000000000000,0x0000000000000000000000000000, 0x0000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000, 0x0000001600000000000000000000000000000000,0x0000FFFF00000000000000000000000000000000, 1,0x80000000)
    p4.table_action_drop_stage2.add_with_action_drop(3)

    #LB
        # 10.10.0.0/24 => port 170 
    p4.table_header_match_stage1.add_with_set_action_id1(4,0x0000000000000000000000000000,0x0000000000000000000000000000, 0x000000000000000000000000000000000A0A0000,0x00000000000000000000000000000000FFFF0000, 0x0000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000, 1,0x00020000)
    p4.table_set_next_stage1.add_with_set_next_stage(4,2)
    p4.table_action_extract_meta_stage1.add_with_action_extract_meta_160(4,0x000000000000000000000000FFFFFFFFFFFFFFFF)

        # 10.10.0.0/24 => port 171 
    p4.table_header_match_stage2.add_with_set_action_id2(4,0x0000000000000000000000000000,0x0000000000000000000000000000, 0x000000000000000000000000000000000A0A0000,0x00000000000000000000000000000000FFFF0000, 0x0000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000, 1,0x00008001)
    p4.table_action_extract_meta_stage2.add_with_action_extract_meta_160(4,0x000000000000000000000000FFFFFFFFFFFFFFFF)
    p4.table_action_hash_stage2.add_with_action_hash2(4)

    p4.table_action_forward_stage2.add_with_action_forward(4,0x00000000,1,1, 170)
    p4.table_action_forward_stage2.add_with_action_forward(4,0x00000001,1,1, 171)

    # p4.table_header_match_stage3.add_with_set_action_id(4,0x0000000000000000000000000000,0x0000000000000000000000000000, 0x000000000000000000000000000000000A0A0A00,0x00000000000000000000000000000000FFFFFF00, 0x0000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000, 0x00001000)
    # p4.table_set_next_stage3.add_with_set_next_stage3(4,3)

    # p4.table_action_hash_stage3.add_with_action_hash3(4)

    # p4.table_action_forward_stage3.add_with_action_forward(4,0x0000,0x0001, 170)
    # p4.table_action_forward_stage3.add_with_action_forward(4,0x0001,0x0001, 171)

    bfrt.complete_operations()
insert_rule(bfrt)